# 技術詳細

## v3.0での重要な修正事項

### ソートボタン重複問題の解決

view画面で更新時にソートボタンが2つ表示される問題を完全に解決しました：

#### 修正内容
1. **初期化前のクリーンアップ強化**
   - `initializeFeatureSystem()`呼び出し前に既存のFeatureManagerを確実にクリーンアップ
   - ページ更新時の重複インスタンス作成を防止

2. **既存ボタン検出の強化**
   - DOM全体から既存ソートボタンを検索・削除
   - 親要素（`dd`タグ）ごと削除することで完全なクリーンアップを実現

3. **多重防御システム**
   - ボタン作成前の最終チェックを追加
   - `data-backlog-sorter`属性による拡張機能要素の識別
   - 複数のチェックポイントで重複を確実に防止

#### 対策の効果
- **ページ更新時**: 既存のFeatureManagerがクリーンアップされるため重複しない
- **SPA遷移時**: 既存ボタンが確実に削除されてから新規作成
- **エラー耐性**: 複数のチェックポイントで重複を防止

この修正により、どのような状況でもソートボタンが1つだけ表示されることが保証されます。

## ボードページ・iframe対応の技術詳細

v2.0で新たに追加されたボードページ対応機能では、以下の高度な技術を実装しています：

### 複雑なページ構造への対応
- **コンテキスト判定**: `window.self !== window.top` によるiframeコンテキストの自動判定
- **URL パターンマッチング**: board ページ (`/board`) と view ページ (`/view/`) の動的判別
- **多層初期化ロジック**: 親ウィンドウ・iframe・通常ページでの適切な初期化分岐

### PostMessage通信システム
- **安全な跨フレーム通信**: 親ウィンドウ⇔iframe間でのメッセージング（`*` オリジン使用）
- **メッセージタイプ管理**: `INIT_SORT_BUTTON` 等の定数化されたメッセージタイプ
- **初期化タイミング制御**: iframe読み込み完了を待機してからの機能初期化

### パフォーマンス最適化
- **デバウンス処理**: iframe src属性の連続変更に対する効率的な処理（100ms遅延）
- **重複処理防止**: `lastProcessedSrc` による同一URL処理のスキップ
- **イベントリスナー最適化**: `{ once: true }` と明示的な `removeEventListener` による確実なクリーンアップ
- **readyState チェック**: 既に読み込み済みのiframeに対する即座の初期化実行

### リソース管理の強化
- **専用オブザーバー管理**: `boardObserver` による board ページ専用の監視システム
- **タイムアウト追跡**: `iframeLoadTimeoutId` による適切なタイマー管理
- **完全なクリーンアップ**: `cleanupBoardObserver()` による確実なリソース解放

この実装により、従来の直接アクセス型のviewページに加えて、複雑なモーダル構造を持つboardページでも同等の高性能なソート機能を提供できるようになりました。

## Chrome Extension 技術スタック

### Manifest V3 対応
- **Service Worker**: バックグラウンドでの状態管理とナビゲーション検知
- **Chrome WebNavigation API**: SPA環境でのページ遷移を正確に検知
- **Chrome Storage API**: 拡張機能の設定を永続的に保存

### 対応サイト
- `https://*.backlog.jp/view/*` (課題ページ)
- `https://*.backlog.com/view/*` (課題ページ)
- `https://*.backlog.jp/board/*` (ボードページ - モーダル内のviewページ)
- `https://*.backlog.com/board/*` (ボードページ - モーダル内のviewページ)

**注記**: 拡張機能は全てのBacklogページで読み込まれますが、実際のソート機能は以下の場所で動作します：
- 課題ページ（URLに`/view/`を含むページ）
- ボードページのモーダル内に表示される課題ページ